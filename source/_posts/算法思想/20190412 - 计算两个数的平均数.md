---
title: 计算两个数的平均数
mathjax: true
date: 2019-04-12 20:28:48
updated:
categories:
tags:
urlname: compute-average-of-two-number
---

计算两个数的平均数，如何不溢出？

<!-- more -->

如果有两个数相加可能溢出，那么如何计算他们的平均值。对于正数和负数，正溢出和负溢出，计算方式可能不一样。

# 正数，正溢出

示例：计算 `Integer.MAX_VALUE` 和 `Integer.MAX_VALUE` 的平均值。

因为 int 类型的二进制位的第一位是符号位，但是在正数计算如果有可能溢出的时候，我们就忽略符号位，把符号位当作数值位来使用，然后采用移位运算。

代码：

```java
int a = Integer.MAX_VALUE;
int b = Integer.MAX_VALUE;
int average = (a + b) >>> 1;
```

对于 `Long.MAX_VALUE` 可以采用同样的方法。

C++ 中没有 `>>>` 运算符，可以写成：

```java
average = ((unsigned int)a + (unsigned int)b)) >> 1;
```

参考：[Extra, Extra - Read All About It: Nearly All Binary Searches and Mergesorts are Broken - Joshua Bloch](http://ai.googleblog.com/2006/06/extra-extra-read-all-about-it-nearly.html)

# 负数，负溢出

示例：计算 `Integer.MIN_VALUE` 和 `Integer.MIN_VALUE` 的平均值。

负数溢出的时候，最高位本应该还是 1，但是溢出的话，最高为会变成 0，所以我们要想办法计算之后让最高位还是1。

如果想要让最高为 1，那么可以和最高为1，其他位都为0的常数做与运算。最高为位1，其他位都为0的数，其十六进制形式为 `0x80000000`，所以代码可以写成：

```java
int a = Integer.MIN_VALUE;
int b = Integer.MIN_VALUE;
int average = ((a + b) >> 1) | 0x80000000;
```



# 完整测试代码

```java
public class AverageTest {
    public static void main(String[] args) {
        int a = Integer.MAX_VALUE;
        int b = Integer.MAX_VALUE;
        int positiveAverage = (a + b) >>> 1;
        System.out.printf("Value of Integer.MAX_VALUE:      %d\n", Integer.MAX_VALUE);
        System.out.printf("Average of two Integer.MAX_VALUE:%d\n", positiveAverage);

        System.out.println("\n--------------------------------------------\n");

        int c = Integer.MIN_VALUE;
        int d = Integer.MIN_VALUE;
        int negativeAverage = ((c + d) >> 1) | 0x80000000;
        System.out.printf("Value of Integer.MIN_VALUE:      %d\n", Integer.MIN_VALUE);
        System.out.printf("Average of two Integer.MIN_VALUE:%d\n", negativeAverage);
    }
}
```



# 参考资料

1. [Extra, Extra - Read All About It: Nearly All Binary Searches and Mergesorts are Broken - Joshua Bloch](http://ai.googleblog.com/2006/06/extra-extra-read-all-about-it-nearly.html)